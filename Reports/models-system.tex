%
% ---- PEPA System Models
%

\section{PEPA System Models}

%
% ---- Simple microservices
%
\subsection{Simple microservices}

\begin{figure}
	\caption{Simple microservices PEPA model}
	\label{figure:simplemicro}
	\centering
	% Automatically generated by PEPA2Latex
	% --begin
	\begin{displaymath}
		\begin{array}{rcl}
			\mathit{a} & = & 1.0 - 10.0\\
			\mathit{c} & = & 1.0\\
			\mathit{w} & = & 100.0\\
			\mathit{db} & = & 6.5\\
			[0.0ex]		\mathit{Website} & \rmdef & (\mathit{athletics},\mathit{a}).\mathit{Website}+(\mathit{cycling},\mathit{c}).\mathit{Website}\\
			\mathit{Worker_A} & \rmdef & (\mathit{athletics},\top).\mathit{WorkerSrv_A}\\
			\mathit{WorkerSrv_A} & \rmdef & (\mathit{workerA},\top).\mathit{Worker_A}\\
			\mathit{Worker_C} & \rmdef & (\mathit{cycling},\top).\mathit{WorkerSrv_C}\\
			\mathit{WorkerSrv_C} & \rmdef & (\mathit{workerC},\top).\mathit{Worker_C}\\
			\mathit{DB_1} & \rmdef & (\mathit{workerA},\mathit{w}).\mathit{DBsrv_1}\\
			\mathit{DBsrv_1} & \rmdef & (\mathit{dbsrv1},\mathit{db}).\mathit{DB_1}\\
			\mathit{DB_2} & \rmdef & (\mathit{workerC},\mathit{w}).\mathit{DBsrv_2}\\
			\mathit{DBsrv_2} & \rmdef & (\mathit{dbsrv2},\mathit{db}).\mathit{DB_2}\\
			\mathit{Service_1} & \rmdef & (\mathit{dbsrv1},\mathit{db}).\mathit{Service_1}\\
			\mathit{Service_2} & \rmdef & (\mathit{dbsrv2},\mathit{db}).\mathit{Service_2}\\
			[0.0ex]		\multicolumn{3}{l}{\mathit{Service_1}\sync{dbsrv1}\mathit{DB_1}\sync{workerA}\mathit{Worker_A}\sync{athletics}\mathit{Website}\sync{cycling}\mathit{Worker_C}\sync{workerC}\mathit{DB_2}\sync{dbsrv2}\mathit{Service_2}}\\
			[0.0ex]	\end{array}
	\end{displaymath}
	% --end
\end{figure}

See the experimental results in Table \ref{table:micro_results}.

\begin{table}[h!]
	\begin{center}
		\caption{Simple microservices experimental results}
		\label{table:micro_results}
		\pgfplotstabletypeset[
		col sep=comma,
		string type,
		columns/a/.style={column name=a, column type={p{.1\textwidth}}},
		columns/athletics/.style={column name=athletics, column type={p{.1\textwidth}}},
		columns/cycling/.style={column name=cycling, column type={p{.1\textwidth}}},
		columns/dbsrv1/.style={column name=dbsrv1, column type={p{.1\textwidth}}},
		columns/dbsrv2/.style={column name=dbsrv2, column type={p{.1\textwidth}}},
		columns/workerA/.style={column name=workerA, column type={p{.1\textwidth}}},
		columns/workerC/.style={column name=workerC, column type={p{.1\textwidth}}},
		every head row/.style={before row=\hline Rate & \multicolumn{6}{c}{Throughput} \\,after row=\hline},
		every last row/.style={after row=\hline},
		]{data/micro/results.csv}
	\end{center}
\end{table}

\begin{figure}
	\caption{Simple microservices experimental results}
	\label{figure:micro_charts}
	\centering
	\begin{tikzpicture}
	\begin{axis}[
	title={Throughput against input rate a},
	xlabel={Rate a},
	ylabel={Throughput},
	xmin=0, xmax=10,
	ymin=0, ymax=7,
	legend pos=north west,
	ymajorgrids=true,
	grid style=dashed,
	cycle multiindex* list={
		mark list*
		\nextlist
		cyan,brown,green,blue,red
	}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/micro/athletics.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/micro/cycling.csv};
	
	\legend{athletics,cycling}
	
	\end{axis}
	\end{tikzpicture}
\end{figure}

%
% ---- Shared queue and distributed database
%
\subsection{Shared queue and distributed database}

\begin{figure}
	\caption{Shared queue and distributed database}
	\label{figure:queuedd}
	\centering
	% Automatically generated by PEPA2Latex
	% --begin
	\begin{displaymath}
	\begin{array}{rcl}
	\mathit{a} & = & 1.0-10.0\\
	\mathit{c} & = & 1.0\\
	\mathit{q} & = & 100.0\\
	\mathit{db} & = & 5.0\\
	[0.0ex]		\mathit{Website} & \rmdef & (\mathit{book_a},\mathit{a}).\mathit{Website}+(\mathit{book_c},\mathit{c}).\mathit{Website}\\
	\mathit{Q_0} & \rmdef & (\mathit{book_a},\top).\mathit{Q_A}+(\mathit{book_c},\top).\mathit{Q_C}\\
	\mathit{Q_A} & \rmdef & (\mathit{queue_a},\top).\mathit{Q_0}\\
	\mathit{Q_C} & \rmdef & (\mathit{queue_c},\top).\mathit{Q_0}\\
	\mathit{DB_1} & \rmdef & (\mathit{queue_a},\mathit{q}).\mathit{DBsrv_1}\\
	\mathit{DBsrv_1} & \rmdef & (\mathit{dbsrv_1},\mathit{db}).\mathit{DB_1}\\
	\mathit{DB_2} & \rmdef & (\mathit{queue_c},\mathit{q}).\mathit{DBsrv_2}\\
	\mathit{DBsrv_2} & \rmdef & (\mathit{dbsrv_2},\mathit{db}).\mathit{DB_2}\\
	\mathit{Service_1} & \rmdef & (\mathit{dbsrv_1},\mathit{db}).\mathit{Service_1}\\
	\mathit{Service_2} & \rmdef & (\mathit{dbsrv_2},\mathit{db}).\mathit{Service_2}\\
	[0.0ex]		\multicolumn{3}{l}{\mathit{Website}\sync{book_a,book_c}\mathit{Q_0}[10.0]\sync{queue_a,queue_c}\mathit{DB_1}\parallel\mathit{DB_2}\sync{dbsrv_1,dbsrv_2}\mathit{Service_1}\parallel\mathit{Service_2}}\\
	[0.0ex]	\end{array}
	\end{displaymath}
	% --end
\end{figure}

See the experimental results in Table \ref{table:queuedd_results}.

\begin{table}[h!]
	\begin{center}
		\caption{Shared queue and distributed database experimental results}
		\label{table:queuedd_results}
		\pgfplotstabletypeset[
		col sep=comma,
		string type,
		columns/a/.style={column name=a, column type={p{.1\textwidth}}},
		columns/booka/.style={column name=book\textsubscript{a}, column type={p{.1\textwidth}}},
		columns/bookc/.style={column name=book\textsubscript{c}, column type={p{.1\textwidth}}},
		columns/qa/.style={column name=queue\textsubscript{a}, column type={p{.1\textwidth}}},
		columns/qc/.style={column name=queue\textsubscript{c}, column type={p{.1\textwidth}}},
		columns/dbsrv1/.style={column name=dbsrv\textsubscript{1}, column type={p{.1\textwidth}}},
		columns/dbsrv2/.style={column name=dbsrv\textsubscript{2}, column type={p{.1\textwidth}}},
		every head row/.style={before row=\hline Rate & \multicolumn{6}{c}{Throughput} \\,after row=\hline},
		every last row/.style={after row=\hline},
		]{data/qddnr/results.csv}
	\end{center}
\end{table}

%
% ---- Shared queue and distributed database with replication
%
\subsection{Shared queue and distributed database with replication}

\begin{figure}
	\caption{Shared queue and distributed database with replication}
	\label{figure:queueddrep}
	\centering
	% Automatically generated by PEPA2Latex
	% --begin
	\begin{displaymath}
	\begin{array}{rcl}
	\mathit{a} & = & 1.0-10.0\\
	\mathit{c} & = & 1.0\\
	\mathit{d} & = & 1.0\\
	\mathit{q} & = & 100.0\\
	\mathit{db} & = & 5.0\\
	[0.0ex]		\mathit{Website} & \rmdef & (\mathit{book_a},\mathit{a}).\mathit{Website}+(\mathit{book_c},\mathit{c}).\mathit{Website}+(\mathit{book_d},\mathit{d}).\mathit{Website}\\
	\mathit{Q_0} & \rmdef & (\mathit{book_a},\top).\mathit{Q_A}+(\mathit{book_c},\top).\mathit{Q_C}+(\mathit{book_d},\top).\mathit{Q_D}\\
	\mathit{Q_A} & \rmdef & (\mathit{queue_a},\top).\mathit{Q_0}\\
	\mathit{Q_C} & \rmdef & (\mathit{queue_c},\top).\mathit{Q_0}\\
	\mathit{Q_D} & \rmdef & (\mathit{queue_d},\top).\mathit{Q_0}\\
	\mathit{DB_1} & \rmdef & (\mathit{queue_a},\mathit{q}).\mathit{DBsrv_1}+(\mathit{queue_c},\mathit{q}).\mathit{DBsrv_1}\\
	\mathit{DBsrv_1} & \rmdef & (\mathit{dbsrv_1},\top).\mathit{DB_1}\\
	\mathit{DB_2} & \rmdef & (\mathit{queue_c},\mathit{q}).\mathit{DBsrv_2}+(\mathit{queue_d},\mathit{q}).\mathit{DBsrv_2}\\
	\mathit{DBsrv_2} & \rmdef & (\mathit{dbsrv_2},\top).\mathit{DB_2}\\
	\mathit{DB_3} & \rmdef & (\mathit{queue_d},\mathit{q}).\mathit{DBsrv_3}+(\mathit{queue_a},\mathit{q}).\mathit{DBsrv_3}\\
	\mathit{DBsrv_3} & \rmdef & (\mathit{dbsrv_3},\top).\mathit{DB_3}\\
	\mathit{Service_1} & \rmdef & (\mathit{dbsrv_1},\mathit{db}).\mathit{Service_1}\\
	\mathit{Service_2} & \rmdef & (\mathit{dbsrv_2},\mathit{db}).\mathit{Service_2}\\
	\mathit{Service_3} & \rmdef & (\mathit{dbsrv_3},\mathit{db}).\mathit{Service_3}\\
	[0.0ex]		\multicolumn{3}{c}{\mathit{Website}\sync{book_a,book_c,book_d}\mathit{Q_0}[10.0]\sync{queue_a,queue_c,queue_d}\mathit{DB_1}\parallel\mathit{DB_2}\parallel\mathit{DB_3}\sync{dbsrv_1,dbsrv_2,dbsrv_3}}\\
	\multicolumn{3}{c}{\mathit{Service_1}\parallel\mathit{Service_2}\parallel\mathit{Service_3}}\\
	[0.0ex]	\end{array}
	\end{displaymath}
	% --end
\end{figure}

See the experimental results in Table \ref{table:queueddwr_results}.

\begin{table}[h!]
	\begin{center}
		\caption{Shared queue and distributed database with replication experimental results}
		\label{table:queueddwr_results}
		\pgfplotstabletypeset[
		col sep=comma,
		string type,
		columns/a/.style={column name=a, column type={p{.1\textwidth}}},
		columns/booka/.style={column name=book\textsubscript{a}, column type={p{.1\textwidth}}},
		columns/bookc/.style={column name=book\textsubscript{c}, column type={p{.1\textwidth}}},
		columns/bookd/.style={column name=book\textsubscript{d}, column type={p{.1\textwidth}}},
		columns/qa/.style={column name=queue\textsubscript{a}, column type={p{.1\textwidth}}},
		columns/qc/.style={column name=queue\textsubscript{c}, column type={p{.1\textwidth}}},
		columns/qd/.style={column name=queue\textsubscript{d}, column type={p{.1\textwidth}}},
		columns/dbsrv1/.style={column name=dbsrv\textsubscript{1}, column type={p{.1\textwidth}}},
		columns/dbsrv2/.style={column name=dbsrv\textsubscript{2}, column type={p{.1\textwidth}}},
		columns/dbsrv3/.style={column name=dbsrv\textsubscript{3}, column type={p{.1\textwidth}}},
		every head row/.style={before row=\hline Rate & \multicolumn{9}{c}{Throughput} \\,after row=\hline},
		every last row/.style={after row=\hline},
		]{data/qddwr/results.csv}
	\end{center}
\end{table}

%
% ---- System comparison
%
\subsection{Comparison}

\begin{shaded}
The system results are compared in Table \ref{table:comparison_results}.

This shows that the simple microservices system does a good job of isolating the skewed demand from the rest of the system, but it is an inefficient use of the database resources.  The actual throughput of the athletics demand is limited to its database's throughput, while the spare capacity of the cycling database goes unused.  Using a distributed database with replication by contrast uses the capacity of two database nodes to serve the skewed demand, so that the actual throughput is much closer to the desired value.

(NOTE: the replication model uses 3 nodes, the others use 2 - need to compare like with like.  Try all with 3 or replication with 2?)
\end{shaded}

\begin{table}[h!]
	\begin{center}
		\caption{Comparison of system results}
		\label{table:comparison_results}
		\pgfplotstabletypeset[
		col sep=comma,
		string type,
		columns/a/.style={column name=a, column type={p{.1\textwidth}}},
		columns/amicro/.style={column name=athletics, column type={p{.15\textwidth}}},
		columns/cmicro/.style={column name=cycling, column type={p{.15\textwidth}}},
		columns/aqddnr/.style={column name=athletics, column type={p{.15\textwidth}}},
		columns/cqddnr/.style={column name=cycling, column type={p{.15\textwidth}}},
		columns/aqddwr/.style={column name=athletics, column type={p{.15\textwidth}}},
		columns/cqddwr/.style={column name=cycling, column type={p{.15\textwidth}}},
		every head row/.style={before row=\hline Rate & \multicolumn{2}{l}{Microservices} & \multicolumn{2}{l}{Queue + Distributed DB} & \multicolumn{2}{l}{Queue + DB with Replication} \\,after row=\hline},
		every last row/.style={after row=\hline},
		]{data/compare.csv}
	\end{center}
\end{table}

\begin{figure}
	\caption{Simple microservices experimental results}
	\label{figure:comparison_charts}
	\centering
	\begin{tikzpicture}
	\begin{axis}[
	title={Throughput of athletics against input rate a},
	width=0.9\textwidth,
	xlabel={Rate a},
	ylabel={Throughput},
	xmin=0, xmax=10,
	ymin=0, ymax=10,
	legend pos=north west,
	legend cell align={left},
	ymajorgrids=true,
	grid style=dashed,
	cycle multiindex* list={
		mark list*
		\nextlist
		cyan,brown,green,blue,red
	}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/micro/athletics.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/qddnr/book_a.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/qddwr/book_a.csv};
	
	\legend{Simple Microservices,Queue + Distributed DB,Queue + Distributed DB with Replication}
	
	\end{axis}
	\end{tikzpicture}
	
		\begin{tikzpicture}
	\begin{axis}[
	title={Throughput of cycling against input rate a},
	width=0.9\textwidth,
	xlabel={Rate a},
	ylabel={Throughput},
	xmin=0, xmax=10,
	ymin=0, ymax=1.2,
	legend pos=south west,
	legend cell align={left},
	ymajorgrids=true,
	grid style=dashed,
	cycle multiindex* list={
		mark list*
		\nextlist
		cyan,brown,green,blue,red
	}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/micro/cycling.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/qddnr/book_c.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/qddwr/book_c.csv};
	
	\legend{Simple Microservices,Queue + Distributed DB,Queue + Distributed DB with Replication}
	
	\end{axis}
	\end{tikzpicture}
\end{figure}