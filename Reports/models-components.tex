%
% ---- PEPA Component Models
%

\section{PEPA Component Models}\label{sec:pepa-component-models}

The first stage is to create suitable PEPA models for the selected technology components from section \ref{sec:technologies}, simple enough to be composed into more complex system models but still able to demonstrate interesting behaviour.  These models are tested using PEPA workbench \cite{RN51} to calculate the steady-state throughputs of each activity for a given range of input rates for the activity with skewed demand.  The results are analysed for any behavioural insights.

%
% ---- Shared middleware queue
%
\FloatBarrier
\subsection{Shared middleware queue}

\begin{shaded}
Queueing systems have already been extensively modelled in PEPA \cite{RN75}.

Queue shared between two processes.

Notes on applying this work to model a real Azure Storage Queue.  A real queue is effectively unlimited, determine what smaller queue size we can use for practicality (smaller state space). 

The PEPA model for a general shared queue is shown in Figure \ref{figure:pepa_queue_model}.
\end{shaded}

\begin{figure}
	\caption{Shared queue PEPA model}
	\label{figure:pepa_queue_model}
	\centering
	% Automatically generated by PEPA2Latex
	% --begin
	\begin{displaymath}
		\begin{array}{rcl}
			\mathit{a} & = & 10.0\\
			\mathit{c} & = & 1.0\\
			\mathit{s1} & = & 5.0\\
			\mathit{s2} & = & 5.0\\
			[2.0ex]		\mathit{Arrival_A} & \rmdef & (\mathit{athletics},\mathit{a}).\mathit{Arrival_A}\\
			\mathit{Arrival_C} & \rmdef & (\mathit{cycling},\mathit{c}).\mathit{Arrival_C}\\
			\mathit{Service_1} & \rmdef & (\mathit{serve1},\mathit{s1}).\mathit{Service_1}\\
			\mathit{Service_2} & \rmdef & (\mathit{serve2},\mathit{s2}).\mathit{Service_2}\\
			\mathit{Q_0} & \rmdef & (\mathit{athletics},\top).\mathit{Q_1}+(\mathit{cycling},\top).\mathit{Q_2}\\
			\mathit{Q_1} & \rmdef & (\mathit{serve1},\top).\mathit{Q_0}\\
			\mathit{Q_2} & \rmdef & (\mathit{serve2},\top).\mathit{Q_0}\\
			[2.0ex]		\multicolumn{3}{l}{\mathit{Arrival_A}\sync{athletics}\mathit{Q_0}[N]\sync{serve1}\mathit{Service_1}\sync{cycling}\mathit{Arrival_C}\sync{serve2}\mathit{Service_2}}\\
			[2.0ex]	\end{array}
	\end{displaymath}
	% --end
\end{figure}

\begin{figure}
	\caption{Shared queue experimental results}
	\label{figure:queue_charts}
	\centering
	\begin{tikzpicture}
	\begin{axis}[
	title={Throughput of athletics against input rate a for different queue lengths N},
	xlabel={Rate a},
	ylabel={Throughput athletics},
	xmin=0, xmax=10,
	ymin=0, ymax=5,
	legend pos=north west,
	ymajorgrids=true,
	grid style=dashed,
	cycle multiindex* list={
		mark list*
		\nextlist
		cyan,brown,green,blue,red
	}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N1_arrive_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N2_arrive_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N5_arrive_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N10_arrive_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N20_arrive_1.csv};
	
	\legend{N = 1, N = 2, N = 5, N = 10, N = 20}
	
	\end{axis}
	\end{tikzpicture}
	
	\begin{tikzpicture}
	\begin{axis}[
	title={Throughput of serve1 against input rate a for different queue lengths N},
	xlabel={Rate a},
	ylabel={Throughput serve1},
	xmin=0, xmax=10,
	ymin=0, ymax=5,
	legend pos=north west,
	ymajorgrids=true,
	grid style=dashed,
	cycle multiindex* list={
		mark list*
		\nextlist
		cyan,brown,green,blue,red
	}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N1_serve_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N2_serve_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N5_serve_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N10_serve_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N20_serve_1.csv};
	
	\legend{N = 1, N = 2, N = 5, N = 10, N = 20}
	
	\end{axis}
	\end{tikzpicture}
	
	\begin{tikzpicture}
	\begin{axis}[
	title={Throughput of cycling against input rate a for different queue lengths N},
	xlabel={Rate a},
	ylabel={Throughput cycling},
	xmin=0, xmax=10,
	ymin=0, ymax=1,
	legend pos=south west,
	ymajorgrids=true,
	grid style=dashed,
	cycle multiindex* list={
		mark list*
		\nextlist
		cyan,brown,green,blue,red
	}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N1_arrive_2.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N2_arrive_2.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N5_arrive_2.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N10_arrive_2.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/queue/N20_arrive_2.csv};
	
	\legend{N = 1, N = 2, N = 5, N = 10, N = 20}
	
	\end{axis}
	\end{tikzpicture}
\end{figure}

\begin{table}[h!]
	\begin{center}
		\caption{Shared queue N=10 experimental results}
		\label{table:queue_results}
		\pgfplotstabletypeset[
		col sep=comma,
		string type,
		columns/a/.style={column name=a, column type={p{.1\textwidth}}},
		columns/athletics/.style={column name=athletics, column type={p{.1\textwidth}}},
		columns/cycling/.style={column name=cycling, column type={p{.1\textwidth}}},
		columns/ratio/.style={column name=ratio, column type={p{.1\textwidth}}},
		columns/serve1/.style={column name=serve1, column type={p{.1\textwidth}}},
		columns/serve2/.style={column name=serve2, column type={p{.1\textwidth}}},
		every head row/.style={before row=\hline Rate & \multicolumn{5}{c}{Throughput} \\,after row=\hline},
		every last row/.style={after row=\hline},
		]{data/queue/N10_results.csv}
	\end{center}
\end{table}

%
% ---- Database models
%
\FloatBarrier
\subsection{Database models}
\begin{shaded}
A very simple representation of a single database process is a component that receives a request for data (either read or write) at some rate based on demand, and serves it at a rate based on the database's performance, e.g.
\begin{center}
$\mathit{DB} \rmdef (\mathit{request}, r).(\mathit{dbsrv}, db).\mathit{DB}$
\end{center}
What doesn't this model?  Statement about how the models below show that it can still be a useful building block.
\end{shaded}

%
% ---- Distributed database without replication
%
\FloatBarrier
\begin{shaded}
\subsubsection{Distributed database.} Figure \ref{figure:pepa_ddnr_model} shows a model of a distributed database, where the data has been partitioned by sport onto two different database nodes with identical performance.  The data request activities are {\itshape athletics} and {\itshape cycling}.  These may represent search, book or return operations on athletics or cycling tickets.  Users may search for either type of ticket from the website component, and the code or database engine will route the search to the correct data node.  Thus $\mathit{DB_1}$ here is able to service {\itshape athletics} requests, at a maximum rate of {\itshape db}, and $\mathit{DB_2}$ can service {\itshape cycling} requests at the same rate.  Both nodes execute in parallel without cooperating on any activities.
Experiments are carried out in PEPA workbench by fixing the input rate of {\itshape db} at 5.0, the rate {\itshape c} of cycling requests to 1.0 and by testing each input rate {\itshape a} of athletics requests from 1.0 to 10.0 in steps of 1.0, to simulate increasing levels of skewed demand for athletics tickets which becomes too high for a database node to service.  The results appear in Table \ref{table:ddnr_results}.
\end{shaded}

\begin{figure}
	\caption{Distributed database PEPA model}
	\label{figure:pepa_ddnr_model}
	\centering
	% Automatically generated by PEPA2Latex
	% --begin
	\begin{displaymath}
	\begin{array}{rcl}
	\mathit{a} & = & 1.0-10.0\\
	\mathit{c} & = & 1.0\\
	\mathit{db} & = & 5.0\\
	[2.0ex]		\mathit{Website} & \rmdef & (\mathit{athletics},\mathit{a}).\mathit{Website}+(\mathit{cycling},\mathit{c}).\mathit{Website}\\
	\mathit{DB_1} & \rmdef & (\mathit{athletics},\top).\mathit{DBsrv_1}\\
	\mathit{DBsrv_1} & \rmdef & (\mathit{dbsrv1},\top).\mathit{DB_1}\\
	\mathit{DB_2} & \rmdef & (\mathit{cycling},\top).\mathit{DBsrv_2}\\
	\mathit{DBsrv_2} & \rmdef & (\mathit{dbsrv2},\top).\mathit{DB_2}\\
	\mathit{Service_1} & \rmdef & (\mathit{dbsrv1},\mathit{db}).\mathit{Service_1}\\
	\mathit{Service_2} & \rmdef & (\mathit{dbsrv2},\mathit{db}).\mathit{Service_2}\\
	[2.0ex]		\multicolumn{3}{l}{\mathit{Website}\sync{\substack{athletics\\cycling}}\mathit{DB_1}\parallel\mathit{DB_2}\sync{\substack{dbsrv1\\dbsrv2}}\mathit{Service_1}\parallel\mathit{Service_2}}\\
	[2.0ex]	\end{array}
	\end{displaymath}
	% --end
\end{figure}

\begin{table}[h!]
	\begin{center}
		\caption{Distributed database experimental results}
		\label{table:ddnr_results}
			\pgfplotstabletypeset[
			col sep=comma,
			string type,
			columns/a/.style={column name=a, column type={p{.1\textwidth}}},
			columns/athletics/.style={column name=athletics, column type={p{.1\textwidth}}},
			columns/cycling/.style={column name=cycling, column type={p{.1\textwidth}}},
			columns/dbsrv1/.style={column name=dbsrv1, column type={p{.1\textwidth}}},
			columns/dbsrv2/.style={column name=dbsrv2, column type={p{.1\textwidth}}},
			every head row/.style={before row=\hline Rate & \multicolumn{4}{c}{Throughput} \\,after row=\hline},
			every last row/.style={after row=\hline},
			]{data/ddnr/results.csv}
	\end{center}
\end{table}

\begin{figure}
	\caption{Distributed database experimental results}
	\label{figure:dd_charts}
	\centering
	\begin{tikzpicture}
	\begin{axis}[
		title={Throughput against input rate a},
		xlabel={Rate a},
		ylabel={Throughput},
		xmin=0, xmax=10,
		ymin=0, ymax=5,
		legend pos=north west,
		ymajorgrids=true,
		grid style=dashed,
		cycle multiindex* list={
			mark list*
				\nextlist
			cyan,brown,green,blue,red
		}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/ddnr/book_a.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/ddnr/book_c.csv};

	\legend{a,c}

	\end{axis}
	\end{tikzpicture}

	\begin{tikzpicture}
	\begin{axis}[
		title={Throughput against input rate a},
		xlabel={Rate a},
		ylabel={Throughput},
		xmin=0, xmax=10,
		ymin=0, ymax=5,
		legend pos=north west,
		ymajorgrids=true,
		grid style=dashed,
		cycle multiindex* list={
			mark list*
				\nextlist
			cyan,brown,green,blue,red
		}
	]
	
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/ddnr/dbsrv_1.csv};
	\addplot table [x index={0}, y index={1}, col sep=comma]{data/ddnr/dbsrv_2.csv};

	\legend{dbsrv1,dbsrv2}

	\end{axis}
	\end{tikzpicture}
\end{figure}

%
% ---- Distributed database with replication
%
\FloatBarrier
\begin{shaded}
\subsubsection{Distributed database with replication.} The PEPA model for a distributed database is shown in Figure \ref{figure:pepa_ddwr_model}.
\end{shaded}

\begin{figure}
	\caption{Distributed database with replication PEPA model}
	\label{figure:pepa_ddwr_model}
	\centering
	% Automatically generated by PEPA2Latex
	% --begin
	\begin{displaymath}
	\begin{array}{rcl}
	\mathit{a} & = & 1.0\\
	\mathit{c} & = & 1.0\\
	\mathit{d} & = & 1.0\\
	\mathit{db} & = & 5.0\\
	[2.0ex]		\mathit{Website} & \rmdef & (\mathit{athletics},\mathit{a}).\mathit{Website}+(\mathit{cycling},\mathit{c}).\mathit{Website}+(\mathit{diving},\mathit{d}).\mathit{Website}\\
	\mathit{DB_1} & \rmdef & (\mathit{athletics},\top).\mathit{DBsrv_1}+(\mathit{cycling},\top).\mathit{DBsrv_1}\\
	\mathit{DBsrv_1} & \rmdef & (\mathit{dbsrv1},\top).\mathit{DB_1}\\
	\mathit{DB_2} & \rmdef & (\mathit{cycling},\top).\mathit{DBsrv_2}+(\mathit{diving},\top).\mathit{DBsrv_2}\\
	\mathit{DBsrv_2} & \rmdef & (\mathit{dbsrv2},\top).\mathit{DB_2}\\
	\mathit{DB_3} & \rmdef & (\mathit{diving},\top).\mathit{DBsrv_3}+(\mathit{athletics},\top).\mathit{DBsrv_3}\\
	\mathit{DBsrv_3} & \rmdef & (\mathit{dbsrv3},\top).\mathit{DB_3}\\
	\mathit{Service_1} & \rmdef & (\mathit{dbsrv1},\mathit{db}).\mathit{Service_1}\\
	\mathit{Service_2} & \rmdef & (\mathit{dbsrv2},\mathit{db}).\mathit{Service_2}\\
	\mathit{Service_3} & \rmdef & (\mathit{dbsrv3},\mathit{db}).\mathit{Service_3}\\
	[2.0ex]		\multicolumn{3}{l}{\mathit{Website}\sync{\substack{athletics\\cycling\\diving}}\mathit{DB_1}\parallel\mathit{DB_2}\parallel\mathit{DB_3}\sync{\substack{dbsrv1\\dbsrv2\\dbsrv3}}\mathit{Service_1}\parallel\mathit{Service_2}\parallel\mathit{Service_3}}\\
	[2.0ex]	\end{array}
	\end{displaymath}
	% --end
\end{figure}

See the experimental results in Table \ref{table:ddwr_results}.

\begin{table}[h!]
	\begin{center}
		\caption{Distributed database with replication experimental results}
		\label{table:ddwr_results}
		\pgfplotstabletypeset[
		col sep=comma,
		string type,
		columns/a/.style={column name=a, column type={p{.1\textwidth}}},
		columns/athletics/.style={column name=athletics, column type={p{.1\textwidth}}},
		columns/cycling/.style={column name=cycling, column type={p{.1\textwidth}}},
		columns/diving/.style={column name=diving, column type={p{.1\textwidth}}},
		columns/dbsrv1/.style={column name=dbsrv1, column type={p{.1\textwidth}}},
		columns/dbsrv2/.style={column name=dbsrv2, column type={p{.1\textwidth}}},
		columns/dbsrv3/.style={column name=dbsrv3, column type={p{.1\textwidth}}},
		every head row/.style={before row=\hline Rate & \multicolumn{6}{c}{Throughput} \\,after row=\hline},
		every last row/.style={after row=\hline},
		]{data/ddwr/results.csv}
	\end{center}
\end{table}

\begin{figure}
	\caption{Distributed database with replication experimental results}
	\label{figure:ddwr_charts}
	\centering
	\begin{tikzpicture}
	\begin{axis}[
		title={Throughput against input rate a},
		width=0.9\textwidth,
		ybar=0pt,
		bar width=.02\textwidth,
		xlabel={Rate a},
		ylabel={Throughput},
		xtick=data,
		ymin=0, ymax=6,
		legend pos=north west,
		ymajorgrids=true,
		grid style=dashed,
	]
	
	\addplot [pattern=north east lines, pattern color=blue] table [x index={0}, y index={1}, col sep=comma]{data/ddwr/book_a.csv};
	\addplot [fill=green] table [x index={0}, y index={1}, col sep=comma]{data/ddwr/book_c.csv};
	\addplot [pattern=crosshatch, pattern color=brown] table [x index={0}, y index={1}, col sep=comma]{data/ddwr/book_d.csv};

	\legend{a,c,d}

	\end{axis}
	\end{tikzpicture}

	\begin{tikzpicture}
	\begin{axis}[
		title={Throughput against input rate a},
		width=0.9\textwidth,
		ybar=0pt,
		bar width=.02\textwidth,
		xlabel={Rate a},
		ylabel={Throughput},
		xtick=data,
		ymin=0, ymax=6,
		legend pos=north west,
		ymajorgrids=true,
		grid style=dashed,
	]
	
	\addplot [pattern=north east lines, pattern color=blue] table [x index={0}, y index={1}, col sep=comma]{data/ddwr/dbsrv_1.csv};
	\addplot [fill=green] table [x index={0}, y index={1}, col sep=comma]{data/ddwr/dbsrv_2.csv};
	\addplot [pattern=crosshatch, pattern color=brown] table [x index={0}, y index={1}, col sep=comma]{data/ddwr/dbsrv_3.csv};

	\legend{dbsrv1,dbsrv2,dbsrv3}

	\end{axis}
	\end{tikzpicture}
\end{figure}